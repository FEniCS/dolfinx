name: DOLFINX CI

on:
  push:
    branches:
      - "*"
  pull_request:
    branches:
      - master

jobs:
  build:
    runs-on: ubuntu-latest
    container: dolfinx/dev-env-real:latest

    steps:
      - uses: actions/checkout@v2
      - name: Install FEniCS Python components
        run: |
          apt-get -qq update
          apt-get -y install clang
          wget https://bootstrap.pypa.io/get-pip.py
          python3 get-pip.py
          pip3 install git+https://github.com/FEniCS/fiat.git --upgrade
          pip3 install git+https://github.com/FEniCS/ufl.git --upgrade
          pip3 install git+https://github.com/FEniCS/ffcx --upgrade
          rm -rf /usr/local/include/dolfin /usr/local/include/dolfin.h

      - name: Configure DOLFINX C++ with CMake
        env:
          CC: clang
          CXX: clang++
        run: |
          mkdir build
          cd build
          cmake -G Ninja -DCMAKE_BUILD_TYPE=Developer ../cpp/
      - name: Build DOLFINX C++
        run: |
          cd build
          ninja install

      - name: Build and run C++ unit tests
        run: |
          cd build
          ninja unittests
          ctest --output-on-failure -R unittests
          mpirun -np 3 ctest --output-on-failure -R unittests
      - name: Build and run C++ regression tests (serial)
        run: |
          cd build
          ninja demos
          ctest -j3 -R demo -R serial
      - name: Build and run C++ regression tests (MPI)
        run: |
          cd build
          ninja demos
          ctest -j3 -R demo -R mpi

      - name: Build Python interface
        # env:
        #   CC: clang
        #   CXX: clang++
        run: |
          cd python
          pip3 -v install . --user
