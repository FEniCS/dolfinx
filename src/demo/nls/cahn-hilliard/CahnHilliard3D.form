# Copyright (C) 2006 Garth N Wells.
# Licensed under the GNU GPL Version 2.
#
# The linearised bilinear form a(v, U) and linear form L(v) for
# the Cahn-Hilliard equation.
#
# Compile this form with FFC: ffc CahnHilliard.form.

P1 = FiniteElement("Lagrange", "tetrahedron", 1)
P2 = FiniteElement("Lagrange", "tetrahedron", 1)

ME = P1 + P2

(v, q)     = BasisFunctions(ME)
(c, k)   = BasisFunctions(ME)  # concentration, potential

(c1, k1) = Functions(ME)      # current solution 

c0         = Function(P1)      # solution from previous converged step 
DcDt0      = Function(P1)      # rate from previous step

mu         = Function(P1)      # chemical potential
DmuDc      = Function(P1)      # derivative of chemical potential wrt concentration 

Mob        = Function(P1)      # mobility
dMob       = Function(P1)      # dmobility

lmbda      = Constant()        # surface parameter

dt         = Constant()           # time step
theta      = Constant()           # time stepping parameter 
dt_inv     = Constant()           # 1/(time step) 
theta_inv  = Constant()           # 1/(time stepping parameter) 



# Compute current rate (this implies the predictor)
DcDt = (c1-c0)*dt_inv*theta_inv - (1-theta)*DcDt0*theta_inv

a1 = v*c*dx + theta*dt*Mob*mu*dot(grad(v), grad(c))*dx \
            + theta*dt*dMob*mu*dot(grad(v), grad(c1))*c*dx \
            + theta*dt*Mob*DmuDc*dot(grad(v), grad(c1))*c*dx \
            - theta*dt*Mob*dot(grad(v), grad(k))*dx

a2 = q*k*dx + lmbda*dot(grad(q), grad(c))*dx

L1int =  theta*dt*Mob*mu*dot(grad(v), grad(c1))*dx  \
       - theta*dt*Mob*dot(grad(v), grad(k1))*dx
L1dyn =  theta*dt*v*DcDt*dx

L2int =  q*k1*dx +   lmbda*dot(grad(q), grad(c1))*dx


a = a1 + a2
L =  - L1int - L1dyn - L2int 
